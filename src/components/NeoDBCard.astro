---
// src/components/NeoDBCard.astro
interface Props {
  record: any;
}

const { record } = Astro.props;

// 计算星星数量
const calculateStars = (rating: number) => {
  if (!rating) return { fullStars: 0, halfStar: 0, emptyStars: 5 };
  const starCount = (rating * 5) / 10;
  const fullStars = Math.floor(starCount);
  const halfStar = rating % 2 ? 1 : 0;
  const emptyStars = 5 - (fullStars + halfStar);
  return { fullStars, halfStar, emptyStars };
};

const { fullStars, halfStar, emptyStars } = calculateStars(record?.rating_grade);

// 格式化日期
const formatDate = (dateString: string) => {
  if (!dateString) return '';
  const date = new Date(dateString);
  return new Intl.DateTimeFormat('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  }).format(date).replace(/\//g, '年') + '日';
};
---

<div class="db-card">
  <div class="db-card-subject">
    <div class="db-card-post">
      <img 
        src={record.item.cover_image_url} 
        alt={record.item.title}
      />
    </div>
    <div class="db-card-content">
      <div class="db-card-title">
        <a href={`https://neodb.social${record.item.url}`} class="cute" target="_blank" rel="noreferrer">
          {record.item.title}
        </a>
      </div>
      
      {/* --- 修改了这里：将日期和星星拆分开 --- */}
      <div class="db-card-rating">
        <div class="rating-date">
            {formatDate(record.created_time)} 读过/看过
        </div>
        <div class="rating-stars">
            {/* 渲染星星 */}
            {[...Array(fullStars)].map(() => <i class="fa-solid fa-star"></i>)}
            {halfStar === 1 && <i class="fa-solid fa-star-half-stroke"></i>}
            {[...Array(emptyStars)].map(() => <i class="fa-regular fa-star"></i>)}
        </div>
      </div>
      {/* ------------------------------------ */}

      {record.comment_text && (
        <div class="db-card-comment">{record.comment_text}</div>
      )}
    </div>
    <div class="db-card-cate">{record.item.category}</div>
  </div>
</div>

<style>
.db-card {
    margin: 1rem 0;
    background: var(--color-codebg, #f9f9f9);
    border-radius: 7px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transition: transform 0.2s ease-in-out;
}
.db-card:hover {
    transform: translateY(-2px);
}
.db-card-subject {
    display: flex;
    align-items: flex-start;
    line-height: 1.6;
    padding: 12px;
    position: relative;
}
.dark .db-card {
    background: var(--color-codebg, #2d2d2d);
}
.db-card-content {
    flex: 1 1 auto;
    overflow: hidden; /* 防止内容溢出 */
    margin-top: 5px;
}
.db-card-post {
    width: 90px;
    margin-right: 15px;
    margin-top: 5px;
    display: flex;
    flex: 0 0 auto;
}
.db-card-title {
    margin-bottom: 5px;
    font-size: 1.2rem;
    color: var(--card-text-color-main, #333);
    font-weight: bold;
    line-height: 1.4;
}
.dark .db-card-title {
    color: #eee;
}
.db-card-title a {
    text-decoration: none!important;
}

/* --- 修改了这里：评分区域的新样式 --- */
.db-card-rating {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 8px;
    display: flex;
    flex-direction: column; /* 让日期和星星垂直排列 */
}

.rating-date {
    margin-bottom: 2px; /* 日期和星星之间的微小间距 */
}

.rating-stars {
    display: flex; /* 确保星星自己在同一行 */
    align-items: center;
    height: 20px; /* 给星星一个固定高度区域 */
}

.rating-stars i {
    color: #f5c518;
    margin-right: 2px; /* 星星之间的间距 */
    font-size: 0.9rem; /* 调整星星大小 */
}
/* -------------------------------- */

.db-card-comment {
    font-size: 0.9rem;
    margin-top: 8px;
    margin-bottom: 10px;
    color: var(--card-text-color-main, #555);
    line-height: 1.6;
}
.dark .db-card-comment { color: #ccc; }
.db-card-cate {
    position: absolute;
    top: 0;
    right: 0;
    background: #8aa2d3;
    color: white;
    padding: 2px 10px;
    font-size: 0.75rem;
    font-style: italic;
    border-radius: 0 7px 0 7px;
    text-transform: capitalize;
}
.db-card-post img {
    width: 100%!important;
    height: auto!important;
    aspect-ratio: 2/3;
    border-radius: 4px;
    object-fit: cover;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
@media (max-width: 600px) {
    .db-card-post { width: 70px; }
    .db-card-title { font-size: 1.1rem; }
}
</style>