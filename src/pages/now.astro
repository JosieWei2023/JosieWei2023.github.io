---
// src/pages/now.astro
import LayoutDefault from "~/layouts/LayoutDefault.astro";

// è‡ªåŠ¨è·å–æ„å»ºæ—¥æœŸï¼ˆè¿™ä¸ªè¿˜æ˜¯ä¿ç•™ï¼‰
const lastModified = new Date().toISOString().split('T')[0];
---

<LayoutDefault >
  <article class="heti prose mx-auto">
    <h1>Now</h1>
    <p class="text-gray-500 italic">
      è¿™æ˜¯æˆ‘çš„ <a href="/about" class="underline hover:text-blue-600">Now é¡µé¢</a>ã€‚æœ€åæ›´æ–°äºï¼š{lastModified}
    </p>
    
    <h3>ğŸ“ å½“å‰çŠ¶æ€</h3>

    <ul>

      <li><strong>åæ ‡ï¼š</strong> åŠ æ‹¿å¤§</li>

      <li><strong>ç”Ÿæ´»ï¼š</strong> æ‹¿åˆ°åŠ æ‹¿å¤§æ°¸å±…ï¼Œæ­£åœ¨åŠç†å„ç§æ–‡ä»¶å’Œæ‰‹ç»­ï¼Œé¡ºä¾¿ç ”ç©¶èƒ½ä¸èƒ½è–…ç¾Šæ¯›æŠ¥é”€ä¸€äº›åŸ¹è®­è´¹ç”¨ã€‚</li>

      <li><strong>çˆ±å¥½ï¼š</strong> å¹´åˆç¡¬æ‹‰ä¸å°å¿ƒä¼¤åˆ°äº†è…°ï¼Œæ­£åœ¨åšåº·å¤æ€§è®­ç»ƒã€‚æœ€è¿‘æ²‰è¿·Kefirå‘é…µé…¸å¥¶</li>

    </ul>

    <h3>ğŸ¬ æœ€è¿‘åœ¨çœ‹</h3>
    <div id="movie-container" class="grid grid-cols-3 gap-4 my-4 min-h-[100px]">
      <div class="col-span-3 text-gray-400 text-sm text-center py-4">æ­£åœ¨ä» NeoDB åŠ è½½æ•°æ®...</div>
    </div>

    <h3>ğŸ“š æœ€è¿‘åœ¨è¯»</h3>
    <ul id="book-container" class="my-4 space-y-2 min-h-[50px]">
      <li class="text-gray-400 text-sm">æ­£åœ¨åŠ è½½ä¹¦å•...</li>
    </ul>

  </article>
</LayoutDefault>

<script is:inline>
// ä½ çš„ NeoDB ç”¨æˆ·å
  const NEODB_USER = 'maoware';

  async function fetchNeoDB() {
    try {
      // ğŸ¬ 1. æŠ“å–ç”µå½± (ä½¿ç”¨ v1/shelf/complete æ¥å£)
      const movieRes = await fetch(`https://neodb.social/api/v1/user/${NEODB_USER}/shelf/complete?category=movie&page=1`);
      
      if (!movieRes.ok) throw new Error('ç”µå½±æ¥å£è¿æ¥å¤±è´¥');
      
      const movieData = await movieRes.json();
      
      // æ¸²æŸ“ç”µå½±
      const movieContainer = document.getElementById('movie-container');
      if (movieData.data && movieData.data.length > 0) {
        movieContainer.innerHTML = movieData.data.slice(0, 3).map(record => `
          <a href="https://neodb.social${record.item.url}" target="_blank" class="flex flex-col items-center group text-decoration-none" style="text-decoration: none;">
            <img 
              src="${record.item.cover_image_url}" 
              alt="${record.item.title}" 
              class="w-full h-auto rounded shadow-sm group-hover:shadow-md transition-all duration-300" 
              style="aspect-ratio: 2/3; object-fit: cover;"
            />
            <span class="text-xs mt-2 text-center leading-tight text-gray-600 group-hover:text-black">
              ${record.item.title}
            </span>
          </a>
        `).join('');
      } else {
        movieContainer.innerHTML = '<div class="col-span-3 text-sm text-gray-400 text-center">æœ€è¿‘æ²¡æœ‰æ ‡è®°çœ‹è¿‡çš„ç”µå½±</div>';
      }

      // ğŸ“š 2. æŠ“å–ä¹¦ç± (ä½¿ç”¨ v1/shelf/complete æ¥å£)
      const bookRes = await fetch(`https://neodb.social/api/v1/user/${NEODB_USER}/shelf/complete?category=book&page=1`);
      
      if (!bookRes.ok) throw new Error('ä¹¦ç±æ¥å£è¿æ¥å¤±è´¥');

      const bookData = await bookRes.json();

      // æ¸²æŸ“ä¹¦ç±
      const bookContainer = document.getElementById('book-container');
      if (bookData.data && bookData.data.length > 0) {
        bookContainer.innerHTML = bookData.data.slice(0, 3).map(record => `
          <li class="flex items-center">
            <span class="mr-2">ğŸ“–</span>
            <a href="https://neodb.social${record.item.url}" target="_blank" class="hover:underline text-gray-800">
              ${record.item.title}
            </a>
            ${record.rating_grade ? `<span class="text-xs text-gray-400 ml-2 border border-gray-200 px-1 rounded">${record.rating_grade}/10</span>` : ''}
          </li>
        `).join('');
      } else {
        bookContainer.innerHTML = '<li class="text-sm text-gray-400">æœ€è¿‘æ²¡æœ‰æ ‡è®°è¯»è¿‡çš„ä¹¦</li>';
      }

    } catch (error) {
      console.error('NeoDB Fetch Error:', error);
      // åªæœ‰åœ¨çœŸçš„å‡ºé”™æ—¶æ‰æ˜¾ç¤ºçº¢å­—
      const errorHtml = '<div class="col-span-3 text-red-400 text-xs text-center">æ•°æ®åŠ è½½é‡åˆ°äº†ä¸€ç‚¹å°é—®é¢˜ï¼Œè¯·ç¨åå†è¯•</div>';
      if(document.getElementById('movie-container')) document.getElementById('movie-container').innerHTML = errorHtml;
      if(document.getElementById('book-container')) document.getElementById('book-container').innerHTML = '<li class="text-red-400 text-xs">åŠ è½½å¤±è´¥</li>';
    }
  }

  // é¡µé¢åŠ è½½å®Œæˆåç«‹å³æ‰§è¡Œ
  fetchNeoDB();
</script>