---
// src/pages/now.astro

// ã€æ³¨æ„ã€‘å¦‚æœä½ çš„é¡¹ç›®æ²¡æœ‰é…ç½® "~" åˆ«åï¼Œè¿™é‡Œå»ºè®®ç”¨ç›¸å¯¹è·¯å¾„ "../"
import LayoutDefault from "../layouts/LayoutDefault.astro";

// 1. NeoDB ç”¨æˆ·åï¼ˆå»ºè®®å»æ‰ @ å’Œåé¢çš„åŸŸåï¼Œåªç•™çº¯ç”¨æˆ·åï¼‰
const neodbUser = 'maoware'; 

// 2. åˆå§‹åŒ–æ•°æ®
// åŠ ä¸Š : any[] å°±æ˜¯å‘Šè¯‰ TS â€œåˆ«ç®¡é‡Œé¢æ˜¯å•¥ï¼Œæ”¾è¿‡æˆ‘â€
let recentMovies: any[] = [];
let recentBooks: any[] = [];

// 3. æŠ“å–é€»è¾‘
try {
  // æŠ“å–æœ€è¿‘çœ‹è¿‡çš„ç”µå½± (category=movie)
  const movieRes = await fetch(`https://neodb.social/api/user/${neodbUser}/catalog/fetch?category=movie`);
  if (movieRes.ok) {
    const movieData = await movieRes.json();
    // åŠ ä¸Š ?. é˜²æ­¢æ•°æ®ä¸ºç©ºæ—¶æŠ¥é”™
    recentMovies = movieData?.data?.slice(0, 3) || []; 
  }

  // æŠ“å–æœ€è¿‘çœ‹è¿‡çš„ä¹¦ (category=book)
  const bookRes = await fetch(`https://neodb.social/api/user/${neodbUser}/catalog/fetch?category=book`);
  if (bookRes.ok) {
    const bookData = await bookRes.json();
    recentBooks = bookData?.data?.slice(0, 3) || [];
  }
} catch (error) {
  console.error("æ— æ³•è¿æ¥åˆ° NeoDBï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åæˆ–ç½‘ç»œ", error);
}

// è‡ªåŠ¨è·å–æ„å»ºæ—¥æœŸ
const lastModified = new Date().toISOString().split('T')[0];
---

<LayoutDefault >
  <article class="heti prose mx-auto">
    <h1>Now</h1>
    <p class="text-gray-500 italic">
      è¿™æ˜¯æˆ‘çš„ <a href="/about" class="underline hover:text-blue-600">Now é¡µé¢</a>ã€‚æœ€åæ›´æ–°äºï¼š{lastModified}
    </p>
    
    <h3>ğŸ“ å½“å‰çŠ¶æ€</h3>
    <ul>
      <li><strong>åæ ‡ï¼š</strong> åŠ æ‹¿å¤§ï¼Œæ¸©å“¥åã€‚</li>
      <li><strong>ç”Ÿæ´»ï¼š</strong> é©¾ç…§å¿…é¡»è¦å»æ›´æ–°äº†ï¼Œä½†æ˜¯å…‰æƒ³æƒ³å„ç§æ‰‹ç»­å’Œæµç¨‹å°±å¥½ç´¯ ğŸ˜«ï¼Œæ— é™æœŸæ‹–å»¶ä¸­ã€‚</li>
      <li><strong>çˆ±å¥½ï¼š</strong> åœ¨åŠªåŠ›æ­»ç£•æŠ±çŸ³ï¼ˆBoulderingï¼‰ï¼Œå¦å¤–æœ€è¿‘æ²‰è¿·å…»å…‹è²å°”ï¼ˆKefirï¼‰èŒè‹—ã€‚</li>
    </ul>

    {/* åªæœ‰å½“æŠ“å–åˆ°ç”µå½±æ•°æ®æ—¶æ‰æ˜¾ç¤ºè¿™ä¸ªæ¨¡å—ï¼Œé˜²æ­¢ç©ºç™½ */}
    {recentMovies.length > 0 && (
      <>
        <h3>ğŸ¬ æœ€è¿‘åœ¨çœ‹</h3>
        <div class="grid grid-cols-3 gap-4 my-4">
          {recentMovies.map((item) => (
            <a href={`https://neodb.social${item.item.url}`} target="_blank" class="flex flex-col items-center normal group">
              <img 
                src={item.item.cover_image_url} 
                alt={item.item.title} 
                class="w-full h-auto rounded shadow-sm group-hover:shadow-md transition-all duration-300 group-hover:-translate-y-1" 
                loading="lazy"
              />
              <span class="text-xs mt-2 text-center leading-tight text-gray-600 group-hover:text-black">
                {item.item.title}
              </span>
            </a>
          ))}
        </div>
      </>
    )}

    {recentBooks.length > 0 && (
      <>
        <h3>ğŸ“š æœ€è¿‘åœ¨è¯»</h3>
        <ul class="my-4 space-y-2">
          {recentBooks.map((item) => (
            <li class="flex items-center">
              <span class="mr-2">ğŸ“–</span>
              <a href={`https://neodb.social${item.item.url}`} target="_blank" class="hover:underline">
                {item.item.title}
              </a>
              {/* å¦‚æœæœ‰è¯„åˆ†æ‰æ˜¾ç¤º */}
              {item.rating > 0 && (
                <span class="text-xs text-gray-400 ml-2 border border-gray-200 px-1 rounded">
                  {item.rating}/10
                </span>
              )}
            </li>
          ))}
        </ul>
      </>
    )}
    
  </article>
</LayoutDefault>