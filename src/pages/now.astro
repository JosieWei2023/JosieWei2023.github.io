---
// src/pages/now.astro
import LayoutDefault from "~/layouts/LayoutDefault.astro";
import NeoDBCard from "~/components/NeoDBCard.astro";

// 1. è·å– Token (åŠ äº† process.env åŒé‡ä¿é™©ï¼Œç»å¯¹è¯»å¾—åˆ°)
const AUTH_TOKEN = import.meta.env.NEODB_TOKEN || process.env.NEODB_TOKEN;

if (!AUTH_TOKEN) {
  console.error("âŒ è­¦å‘Šï¼šæœªæ‰¾åˆ° NEODB_TOKEN ç¯å¢ƒå˜é‡ï¼Œè¯·æ£€æŸ¥ GitHub Secretsï¼");
}

// 2. æŠ“å–æ•°æ®çš„é€šç”¨å‡½æ•°
async function fetchNeoDB(category: string) {
  try {
    // ğŸš¨ ä¿®æ­£ï¼šæŠŠ /fetch æ¢æˆäº† /complete (ä»£è¡¨å·²çœ‹/å·²è¯»çš„ä¹¦æ¶)ï¼Œå¹¶åŠ ä¸Šäº† page=1
    const res = await fetch(`https://neodb.social/api/me/shelf/complete?category=${category}&page=1`, {
      headers: {
        Authorization: `Bearer ${AUTH_TOKEN}`,
        Accept: 'application/json',
      },
    });
    
    if (!res.ok) {
        console.error(`NeoDB æŠ“å–å¤±è´¥ (${category}): HTTP ${res.status}`);
        return [];
    }
    
    const json = await res.json();
    // æ‹¿åˆ°æ•°æ®åï¼Œåªæˆªå–å‰ 4 ä¸ªå±•ç¤º
    return json.data ? json.data.slice(0, 4) : [];
  } catch (error) {
    console.error(`NeoDB è¯·æ±‚å‡ºé”™ (${category}):`, error);
    return [];
  }
}

// 3. åœ¨æ„å»ºæ—¶ç›´æ¥æŠ“å–æ•°æ®
// å› ä¸ºç”¨äº† api/me æ¥å£ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«è¿™ä¸ª Token å±äºè°ï¼Œä¸ç”¨å¡«ç”¨æˆ·å
const recentMovies = await fetchNeoDB('movie');
const recentBooks = await fetchNeoDB('book');

// è‡ªåŠ¨è·å–æ„å»ºæ—¥æœŸ
const lastModified = new Date().toISOString().split('T')[0];
---

<LayoutDefault >
  <article class="heti prose mx-auto">
    <h1>Now</h1>
    <p class="text-gray-500 italic">
      æœ€åæ›´æ–°äºï¼š{lastModified}
    </p>
    
    <h3>ğŸ“ å½“å‰çŠ¶æ€</h3>
    <ul>
      <li><strong>åæ ‡</strong> åŠ æ‹¿å¤§</li>
      <li><strong>è¿åŠ¨</strong> å¹´å‰ç¡¬æ‹‰ä¼¤åˆ°äº†è…°æ¤ï¼Œè¿‘æœŸåœ¨åŠªåŠ›åšè…°æ¤åº·å¤è®­ç»ƒä»¥åŠè¯•å›¾æ”¹å–„ä½“æ€å’Œè‚Œè‚‰ä¸å¹³è¡¡ã€‚æŠ±çŸ³æ”€å²©æš‚åœä¸­ã€‚æ—¥å¸¸ä¹Ÿåœ¨è§„å¾‹è¡¥å……ç»´ D å’Œé•æ¥åŠ©çœ æ¢å¤ã€‚</li>
      <li><strong>å·¥ä½œ</strong>æ‹¿åˆ°åŠ æ‹¿å¤§æ°¸å±…èº«ä»½ï¼Œæ­£åœ¨ç§¯æå¯»æ±‚æ”¿åºœå¸®åŠ©ï¼Œè°‹æ±‚è´¢åŠ¡/ä¼šè®¡ç›¸å…³çš„å·¥ä½œæœºä¼šï¼ŒåŒæ—¶ä¹Ÿåœ¨è‡ªå­¦å¦‚ä½•æ‰“ç†è‡ªå®¶æ°´æš–ä¸šåŠ¡çš„è´¢åŠ¡éƒ¨åˆ†ã€‚</li>
      <li><strong>çˆ±å¥½</strong> æ²‰è¿·Kefiré…¸å¥¶å‘é…µï¼Œæ­£åœ¨åŠªåŠ›æ•£æ’­Kefir Grainsåˆ°å››é¢å…«æ–¹ï¼</li>
      
    </ul>

    

    {/* ç”µå½±æ¿å— */}
    {recentMovies.length > 0 && (
      <>
        <h3>ğŸ¬ æœ€è¿‘çœ‹è¿‡</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 my-4">
          {recentMovies.map((record: any) => (
            <NeoDBCard record={record} />
          ))}
        </div>
      </>
    )}

    {/* ä¹¦ç±æ¿å— */}
    {recentBooks.length > 0 && (
      <>
        <h3>ğŸ“š æœ€è¿‘è¯»è¿‡</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 my-4">
          {recentBooks.map((record: any) => (
            <NeoDBCard record={record} />
          ))}
        </div>
      </>
    )}
    
    {/* å¦‚æœéƒ½æ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºæç¤º */}
    {recentMovies.length === 0 && recentBooks.length === 0 && (
       <p class="text-gray-400 text-sm italic">æš‚æ—¶æ— æ³•è·å– NeoDB æ•°æ®ï¼Œè¯·ç¨åå†è¯•ã€‚</p>
    )}
    
  </article>
</LayoutDefault>