---
// src/pages/now.astro
import LayoutDefault from "~/layouts/LayoutDefault.astro";


// 1. è·å– Token (åŠ äº† process.env åŒé‡ä¿é™©ï¼Œç»å¯¹è¯»å¾—åˆ°)
const AUTH_TOKEN = import.meta.env.NEODB_TOKEN || process.env.NEODB_TOKEN;

if (!AUTH_TOKEN) {
  console.error("âŒ è­¦å‘Šï¼šæœªæ‰¾åˆ° NEODB_TOKEN ç¯å¢ƒå˜é‡ï¼Œè¯·æ£€æŸ¥ GitHub Secretsï¼");
}

// 2. æŠ“å–æ•°æ®çš„é€šç”¨å‡½æ•°
async function fetchNeoDB(category: string) {
  try {
    // ğŸš¨ ä¿®æ­£ï¼šæŠŠ /fetch æ¢æˆäº† /complete (ä»£è¡¨å·²çœ‹/å·²è¯»çš„ä¹¦æ¶)ï¼Œå¹¶åŠ ä¸Šäº† page=1
    const res = await fetch(`https://neodb.social/api/me/shelf/complete?category=${category}&page=1`, {
      headers: {
        Authorization: `Bearer ${AUTH_TOKEN}`,
        Accept: 'application/json',
      },
    });
    
    if (!res.ok) {
        console.error(`NeoDB æŠ“å–å¤±è´¥ (${category}): HTTP ${res.status}`);
        return [];
    }
    
    const json = await res.json();
    // æ‹¿åˆ°æ•°æ®åï¼Œåªæˆªå–å‰ 3 ä¸ªå±•ç¤º
    return json.data ? json.data.slice(0, 3) : [];
  } catch (error) {
    console.error(`NeoDB è¯·æ±‚å‡ºé”™ (${category}):`, error);
    return [];
  }
}

// 3. åœ¨æ„å»ºæ—¶ç›´æ¥æŠ“å–æ•°æ®
// å› ä¸ºç”¨äº† api/me æ¥å£ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«è¿™ä¸ª Token å±äºè°ï¼Œä¸ç”¨å¡«ç”¨æˆ·å
const recentMovies = await fetchNeoDB('movie');
const recentBooks = await fetchNeoDB('book');

// è‡ªåŠ¨è·å–æ„å»ºæ—¥æœŸ
const lastModified = new Date().toISOString().split('T')[0];
---

<LayoutDefault >
  <article class="heti prose mx-auto">
    <h1>Now</h1>
    <p class="text-gray-500 italic">
      è¿™æ˜¯æˆ‘çš„ <a href="/now" class="underline hover:text-blue-600">Now é¡µé¢</a>ã€‚æœ€åæ›´æ–°äºï¼š{lastModified}
    </p>
    
    <h3>ğŸ“ å½“å‰çŠ¶æ€</h3>
    <ul>
      <li><strong>åæ ‡</strong> åŠ æ‹¿å¤§</li>
      <li><strong>ç”Ÿæ´»</strong> æ°¸å±…åˆ°æ‰‹ï¼Œæ­£åœ¨é™†ç»­åŠç†å„ç§æ–‡ä»¶å’Œæ‰‹ç»­ã€‚</li>
      <li><strong>çˆ±å¥½</strong> æŠ±çŸ³ (Bouldering) & å…‹è²å°” (Kefir) å‘é…µã€‚</li>
    </ul>

    {/* ç”µå½±æ¿å— */}
    {recentMovies.length > 0 && (
      <>
        <h3>ğŸ¬ æœ€è¿‘åœ¨çœ‹</h3>
        <div class="grid grid-cols-3 gap-4 my-4">
          {recentMovies.map((record: any) => (
            <a href={`https://neodb.social${record.item.url}`} target="_blank" class="flex flex-col items-center group normal">
              <div class="relative w-full aspect-[2/3] overflow-hidden rounded shadow-sm group-hover:shadow-md transition-all">
                <img 
                  src={record.item.cover_image_url} 
                  alt={record.item.title} 
                  class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" 
                />
              </div>
              <span class="text-xs mt-2 text-center leading-tight text-gray-600 group-hover:text-black">
                {record.item.title}
              </span>
            </a>
          ))}
        </div>
      </>
    )}

    {/* ä¹¦ç±æ¿å— */}
    {recentBooks.length > 0 && (
      <>
        <h3>ğŸ“š æœ€è¿‘åœ¨è¯»</h3>
        <ul class="my-4 space-y-2">
          {recentBooks.map((record: any) => (
            <li class="flex items-center">
              <span class="mr-2">ğŸ“–</span>
              <a href={`https://neodb.social${record.item.url}`} target="_blank" class="hover:underline text-gray-800">
                {record.item.title}
              </a>
              {/* å¦‚æœæœ‰è¯„åˆ†å°±æ˜¾ç¤º */}
              {record.rating_grade && (
                <span class="text-xs text-gray-400 ml-2 border border-gray-200 px-1 rounded">
                  {record.rating_grade}/10
                </span>
              )}
            </li>
          ))}
        </ul>
      </>
    )}
    
    {/* å¦‚æœéƒ½æ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºæç¤º */}
    {recentMovies.length === 0 && recentBooks.length === 0 && (
       <p class="text-gray-400 text-sm italic">æš‚æ—¶æ— æ³•è·å– NeoDB æ•°æ®ï¼Œè¯·ç¨åå†è¯•ã€‚</p>
    )}
    
  </article>
</LayoutDefault>